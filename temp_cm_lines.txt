   1: /**
   2:  * 聊天配置管理器
   3:  *
   4:  * 职责：
   5:  * - 管理多 Provider 配置（Gemini、OpenAI、Anthropic）
   6:  * - 同步表单字段与 localStorage 存储
   7:  * - 处理 Provider 切换时的配置保存和恢复
   8:  * - 规范化和验证配置参数（API URL、模型、思考预算、搜索模式等）
   9:  * - 支持新旧配置格式的兼容（profiles vs 扁平结构）
  10:  *
  11:  * 依赖：constants.js, safe-storage.js
  12:  * 被依赖：api-manager, chat.js
  13:  */
  14: 
  15: import { normalizeFromUi, formatForUi } from './thinking-config.js';
  16: 
  17: // 支持的 Provider ID 列表
  18: const SUPPORTED_PROVIDER_IDS = Object.values(CHAT_PROVIDER_IDS);
  19: 
  20: // OpenAI 推理级别枚举
  21: const OPENAI_REASONING_LEVELS = new Set(['none', 'minimal', 'low', 'medium', 'high', 'xhigh']);
  22: const ARK_THINKING_LEVELS = new Set(['minimal', 'low', 'medium', 'high']);
  23: 
  24: // 各 Provider 的搜索模式枚举
  25: const GEMINI_SEARCH_MODES = new Set(['', 'gemini_google_search']);
  26: const ANTHROPIC_SEARCH_MODES = new Set(['', 'anthropic_web_search']);
  27: const ARK_SEARCH_MODES = new Set(['', 'ark_web_search']);
  28: const OPENAI_SEARCH_MODES = new Set([
  29:     '',
  30:     'openai_web_search'
  31: ]);
  32: \n    }
  33:     /**
  34:      * 切换 Provider
  35:      *
  36:      * 在切换前保存当前 Provider 的表单值，切换后加载新 Provider 的配置
  37:      *
  38:      * @param {string} nextProviderRaw - 新 Provider ID
  39:      * @param {Object} options - 选项
  40:      * @param {boolean} options.dispatchSearchChange - 是否触发搜索模式 change 事件
  41:      */
  42:     function switchProvider(nextProviderRaw, { dispatchSearchChange = true } = {}) {
  43:         const nextProvider = normalizeProvider(nextProviderRaw);
  44:         if (nextProvider === activeProvider) {
  45:             return;
  46:         }
  47: 
  48:         profiles[activeProvider] = readProviderFields(activeProvider);
  49:         activeProvider = nextProvider;
  50:         applyProviderProfile(activeProvider, profiles[activeProvider], { dispatchSearchChange });
  51:     }
  52: 
  53:     /**
  54:      * 将配置应用到表单
  55:      *
  56:      * @param {Object} config - 完整配置对象
  57:      */
  58:     function applyConfigToForm(config) {
  59:         profiles = cloneProfiles(config.profiles);
  60:         activeProvider = config.provider;
  61: 
  62:         if (cfgProvider) {
  63:             cfgProvider.value = config.provider;
  64:         }
  65: 
  66:         applyProviderProfile(activeProvider, profiles[activeProvider], { dispatchSearchChange: false });
  67:         cfgPrompt.value = config.systemPrompt;
  68: 
  69:         if (cfgEnablePseudoStream) {
  70:             cfgEnablePseudoStream.checked = config.enablePseudoStream;
  71:         }
  72: 
  73:         if (cfgEnableDraftAutosave) {
  74:             cfgEnableDraftAutosave.checked = config.enableDraftAutosave;
  75:         }
  76: 
  77:         cfgPrefixWithTime.checked = config.prefixWithTime;
  78:         cfgPrefixWithName.checked = config.prefixWithName;
  79:         cfgUserName.value = config.userName;
  80: 
  81:         if (cfgSearchMode) {
  82:             dispatchChange(cfgSearchMode);
  83:         }
  84:     }
  85: 
  86:     /**
  87:      * 从表单读取完整配置
  88:      *
  89:      * @returns {Object} 完整配置对象
  90:      */
  91:     function readConfigFromForm() {
  92:         const selectedProvider = cfgProvider ? normalizeProvider(cfgProvider.value) : activeProvider;
  93:         if (selectedProvider !== activeProvider) {
  94:             switchProvider(selectedProvider);
  95:         }
  96: 
  97:         profiles[activeProvider] = readProviderFields(activeProvider);
  98:         const activeProfile = profiles[activeProvider];
  99: 
 100:         return {
 101:             provider: activeProvider,
 102:             profiles: cloneProfiles(profiles),
 103:             apiUrl: activeProfile.apiUrl,
 104:             apiKey: activeProfile.apiKey,
 105:             backupApiKey: activeProfile.backupApiKey,
 106:             model: activeProfile.model,
 107:             thinkingBudget: Object.prototype.hasOwnProperty.call(activeProfile, 'thinkingBudget')
 108:                 ? activeProfile.thinkingBudget
 109:                 : null,
 110:             thinkingLevel: Object.prototype.hasOwnProperty.call(activeProfile, 'thinkingLevel')
 111:                 ? activeProfile.thinkingLevel
 112:                 : null,
 113:             thinkingEffort: Object.prototype.hasOwnProperty.call(activeProfile, 'thinkingEffort')
 114:                 ? activeProfile.thinkingEffort
 115:                 : null,
 116:             searchMode: activeProfile.searchMode,
 117:             systemPrompt: cfgPrompt.value,
 118:             enablePseudoStream: cfgEnablePseudoStream ? cfgEnablePseudoStream.checked : CHAT_DEFAULTS.enablePseudoStream,
 119:             enableDraftAutosave: cfgEnableDraftAutosave ? cfgEnableDraftAutosave.checked : CHAT_DEFAULTS.enableDraftAutosave,
 120:             prefixWithTime: cfgPrefixWithTime.checked,
 121:             prefixWithName: cfgPrefixWithName.checked,
 122:             userName: cfgUserName.value
 123:         };
 124:     }
 125: 
 126:     /**
 127:      * 从 localStorage 加载配置并应用到表单
 128:      */
 129:     function loadConfig() {
 130:         const config = normalizeStoredConfig(
 131:             safeGetJson(storageKey, {}, globalThis.localStorage)
 132:         );
 133:         applyConfigToForm(config);
 134:     }
 135: 
 136:     /**
 137:      * 从表单读取配置并保存到 localStorage
 138:      */
 139:     function saveConfig() {
 140:         const config = normalizeStoredConfig(readConfigFromForm());
 141:         safeSetJson(storageKey, config, globalThis.localStorage);
 142:     }
 143: 
 144:     /**
 145:      * 获取当前配置
 146:      *
 147:      * @returns {Object} 当前配置对象
 148:      */
 149:     function getConfig() {
 150:         const config = normalizeStoredConfig(readConfigFromForm());
 151:         return {
 152:             ...config,
 153:             systemPrompt: config.systemPrompt || CHAT_DEFAULTS.systemPrompt
 154:         };
 155:     }
 156: 
 157:     // 监听 Provider 选择器的 change 事件
 158:     if (cfgProvider && typeof cfgProvider.addEventListener === 'function') {
 159:         cfgProvider.addEventListener('change', () => {
 160:             switchProvider(cfgProvider.value);
 161:         });
 162:     }
 163: 
 164:     return {
 165:         loadConfig,
 166:         saveConfig,
 167:         getConfig
 168:     };
 169: }
 170: 
 171: 
 172: 
 173: 
 174: 
 175: 
 176: 
 177: 
 178: 
 179: 
 180: 
